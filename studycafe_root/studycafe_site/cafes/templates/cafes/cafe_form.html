{% extends "base.html" %}
{% block content %}
  <div class="form-container" style="max-width: 800px;">
    <h1 class="form-title">{% if form.instance.pk %}Edit Cafe{% else %}Add New Cafe{% endif %}</h1>
    
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      
      {% for field in form %}
        <div class="form-group">
          <label for="{{ field.id_for_label }}" class="form-label">
            {{ field.label }}
            {% if field.field.required %}<span style="color: #dc3545;">*</span>{% endif %}
          </label>
          
          {% if field.name == 'description' %}
            <textarea name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-textarea">{{ field.value|default:'' }}</textarea>
          {% elif field.name == 'has_wifi' or field.name == 'has_power_outlet' or field.name == 'has_restroom' %}
            <div style="display: flex; align-items: center;">
              <input type="checkbox" name="{{ field.name }}" id="{{ field.id_for_label }}" {% if field.value %}checked{% endif %} style="width: auto; margin-right: 10px;">
              <label for="{{ field.id_for_label }}" style="margin: 0; font-weight: normal; cursor: pointer;">
                {% if field.name == 'has_wifi' %}üì∂ WiFi Available
                {% elif field.name == 'has_power_outlet' %}üîå Power Outlets
                {% elif field.name == 'has_restroom' %}üöª Restroom Access
                {% endif %}
              </label>
            </div>
          {% elif field.name == 'opening_time' or field.name == 'closing_time' %}
            <input type="time" name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-input" value="{{ field.value|default:'' }}">
          {% elif field.name == 'latitude' or field.name == 'longitude' %}
            <input type="hidden" name="{{ field.name }}" value="{{ field.value|default:'' }}">
          {% else %}
            <input type="{{ field.field.widget.input_type|default:'text' }}" name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-input" value="{{ field.value|default:'' }}" {% if field.field.required %}required{% endif %}>
          {% endif %}
          
          {% if field.errors %}
            <p class="error-text small-text">{{ field.errors.0 }}</p>
          {% endif %}
          {% if field.help_text %}
            <p class="small-text" style="color: #666; margin-top: 5px;">{{ field.help_text }}</p>
          {% endif %}
        </div>
      {% endfor %}

      <!-- Location Section -->
      <div class="form-group">
        <label class="form-label">üìç Cafe Location</label>
        <div class="search-box" style="margin-bottom: 15px;">
          <input type="text" id="address-search" class="search-input" placeholder="Search for an address...">
          <button type="button" id="address-search-btn" class="search-btn">Search</button>
        </div>
        <div id="resolved-address" style="padding: 10px; background-color: #f8f8f8; border-radius: 5px; margin-bottom: 15px; font-style: italic; color: #555;"></div>
        <div id="map" class="map-element" style="height: 400px; border-radius: 10px; overflow: hidden;"></div>
      </div>

      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button type="submit" class="form-submit" style="flex: 1;">
          {% if form.instance.pk %}Update Cafe{% else %}Add Cafe{% endif %}
        </button>
        <a href="{% url 'cafe-list' %}" class="action-btn" style="background-color: #666; color: white; flex: 0 0 auto;">Cancel</a>
      </div>
    </form>
  </div>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Helper to reverse geocode lat/lng to address
    function reverseGeocode(lat, lon) {
      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon)
        .then(response => response.json())
        .then(data => {
          document.getElementById('resolved-address').textContent = data.display_name || '';
        });
    }

    // Try to use user's GPS location, else fallback to existing or default
    function initMap() {
      var lat = parseFloat(document.querySelector('input[name="latitude"]').value) || null;
      var lon = parseFloat(document.querySelector('input[name="longitude"]').value) || null;

      function createMap(lat, lon) {
        var map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
        var marker = L.marker([lat, lon], {draggable:true}).addTo(map);

        // Update hidden fields and address when marker is dragged
        marker.on('dragend', function(e) {
          var latlng = marker.getLatLng();
          document.querySelector('input[name="latitude"]').value = latlng.lat;
          document.querySelector('input[name="longitude"]').value = latlng.lng;
          reverseGeocode(latlng.lat, latlng.lng);
        });

        // Geocode address function
        function geocodeAddress() {
          var address = document.getElementById('address-search').value;
          fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address))
            .then(response => response.json())
            .then(data => {
              if (data && data.length > 0) {
                var lat = parseFloat(data[0].lat);
                var lon = parseFloat(data[0].lon);
                map.setView([lat, lon], 16);
                marker.setLatLng([lat, lon]);
                document.querySelector('input[name="latitude"]').value = lat;
                document.querySelector('input[name="longitude"]').value = lon;
                reverseGeocode(lat, lon);
              } else {
                alert('Address not found!');
              }
            });
        }

        // Search on Enter
        document.getElementById('address-search').addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            geocodeAddress();
          }
        });

        // Search on Button Click
        document.getElementById('address-search-btn').addEventListener('click', function() {
          geocodeAddress();
        });

        // Show address for initial marker
        reverseGeocode(lat, lon);
      }

      if (lat && lon) {
        createMap(lat, lon);
      } else if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var userLat = position.coords.latitude;
          var userLon = position.coords.longitude;
          document.querySelector('input[name="latitude"]').value = userLat;
          document.querySelector('input[name="longitude"]').value = userLon;
          createMap(userLat, userLon);
        }, function() {
          // Fallback to a default location (e.g., New York)
          document.querySelector('input[name="latitude"]').value = 40.7128;
          document.querySelector('input[name="longitude"]').value = -74.0060;
          createMap(40.7128, -74.0060);
        });
      } else {
        document.querySelector('input[name="latitude"]').value = 40.7128;
        document.querySelector('input[name="longitude"]').value = -74.0060;
        createMap(40.7128, -74.0060);
      }
    }

    window.onload = initMap;
  </script>
{% endblock %}
