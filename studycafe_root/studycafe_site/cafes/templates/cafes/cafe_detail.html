{% extends "base.html" %}
{% block content %}
  <h1>{{ cafe.name }}</h1>
  <p><strong>Posted by:</strong> {{ cafe.posted_by.username }}
    {% if user.is_authenticated and user != cafe.posted_by %}
      {% if cafe.posted_by in user.following.values_list.following %}
        <form action="{% url 'unfollow-user' cafe.posted_by.id %}" method="post" class="inline-form">
          {% csrf_token %}
          <button type="submit" class="unfollow-btn">Unfollow</button>
        </form>
      {% else %}
        <form action="{% url 'follow-user' cafe.posted_by.id %}" method="post" class="inline-form">
          {% csrf_token %}
          <button type="submit" class="follow-btn">Follow</button>
        </form>
      {% endif %}
    {% endif %}
  </p>
  <p><strong>Address:</strong> {{ cafe.address }}</p>
  <p><strong>Description:</strong> {{ cafe.description }}</p>
  <p><strong>WiFi:</strong> {{ cafe.has_wifi|yesno:"Yes,No" }}</p>
  <p><strong>Power Outlets:</strong> {{ cafe.has_power_outlet|yesno:"Yes,No" }}</p>
  <p><strong>Restroom:</strong> {{ cafe.has_restroom|yesno:"Yes,No" }}</p>
  {% if cafe.opening_time and cafe.closing_time %}
    <p><strong>Hours:</strong> {{ cafe.opening_time|time:"g:i A" }} - {{ cafe.closing_time|time:"g:i A" }}
    {% if cafe.is_open_now %}
      <span style="color: green;">üïê Open now</span>
    {% elif cafe.is_open_now == False %}
      <span style="color: red;">üïê Closed</span>
    {% endif %}
    </p>
  {% endif %}
  {% if cafe.photo %}
    <img src="{{ cafe.photo.url }}" alt="Cafe photo" style="max-width:300px;">
  {% endif %}

  <!-- Photo Gallery -->
  <h3>Photo Gallery</h3>
  <div class="photo-gallery">
    {% for photo in photos %}
      <div class="photo-item">
        <img src="{{ photo.image.url }}" alt="{{ photo.caption }}" class="gallery-image">
        {% if photo.caption %}
          <p class="photo-caption">{{ photo.caption }}</p>
        {% endif %}
        <p class="photo-credit">by {{ photo.uploaded_by.username }}</p>
        {% if user == photo.uploaded_by or user == cafe.posted_by %}
          <form action="{% url 'delete-photo' photo.id %}" method="post" class="delete-photo-form">
            {% csrf_token %}
            <button type="submit" class="delete-photo-btn">√ó</button>
          </form>
        {% endif %}
      </div>
    {% empty %}
      <p>No photos yet. Be the first to add one!</p>
    {% endfor %}
  </div>

  {% if user.is_authenticated %}
    <h4>Add a Photo</h4>
    <form action="{% url 'add-photo' cafe.id %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {{ photo_form.as_p }}
      <button type="submit">Upload Photo</button>
    </form>
  {% endif %}

  <!-- map integration -->
  {% if cafe.latitude and cafe.longitude %}
    <h3>Location</h3>
    <div id="map" style="height: 300px; margin-bottom: 1em; border: 1px solid #ccc;"></div>
    <div id="resolved-address" style="margin: 0.5em 0; color: #555; font-style: italic;"></div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      var lat = {{ cafe.latitude }};
      var lon = {{ cafe.longitude }};
      var map = L.map('map').setView([lat, lon], 16);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
      
      // Add a custom marker with cafe name
      var marker = L.marker([lat, lon]).addTo(map);
      marker.bindPopup('<strong>{{ cafe.name|escapejs }}</strong><br>{{ cafe.address|escapejs }}').openPopup();

      // Show the full address below the map
      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon)
        .then(response => response.json())
        .then(data => {
          if (data && data.display_name) {
            document.getElementById('resolved-address').textContent = data.display_name;
          } else {
            document.getElementById('resolved-address').textContent = '{{ cafe.address }}';
          }
        })
        .catch(error => {
          document.getElementById('resolved-address').textContent = '{{ cafe.address }}';
        });
    </script>
  {% else %}
    <p><em>Location not available for this cafe.</em></p>
  {% endif %}
  <p>
    <!-- so that only users who posted can edit the cafe -->
    {% if user == cafe.posted_by %}
      <a href="{% url 'cafe-update' cafe.pk %}">Edit</a> |
      <a href="{% url 'cafe-delete' cafe.pk %}">Delete</a> |
    {% endif %}
    <a href="{% url 'cafe-list' %}">Back to list</a>
  </p>
  <hr>
  <h2>Ratings{% if cafe.average_rating > 0 %} (Average: ‚≠ê {{ cafe.average_rating|floatformat:1 }}/5){% endif %}</h2>
  <ul>
    {% for rating in cafe.ratings.all %}
      <li>
        <strong>{{ rating.user.username }}</strong>: {{ rating.stars }} stars
        {% if rating.comment %} - "{{ rating.comment }}"{% endif %}
        {% if user == rating.user %}
          <form action="{% url 'delete-rating' rating.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Delete</button>
          </form>
        {% endif %}
      </li>
    {% empty %}
      <li>No ratings yet.</li>
    {% endfor %}
  </ul>
  {% if user.is_authenticated %}
    <h3>Add/Update Your Rating</h3>
    <form action="{% url 'add-rating' cafe.id %}" method="post">
      {% csrf_token %}
      <label for="stars">Stars (1-5):</label>
      <input type="number" name="stars" min="1" max="5" required>
      <br>
      <label for="comment">Comment:</label>
      <input type="text" name="comment">
      <br>
      <button type="submit">Submit</button>
    </form>
  {% else %}
    <p><a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to rate this cafe.</p>
  {% endif %}

  <!-- bookmark -->
  {% if user.is_authenticated %}
    {% if is_bookmarked %}
      <form action="{% url 'remove-bookmark' cafe.id %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit">Remove from saved</button>
      </form>
    {% else %}
      <form action="{% url 'add-bookmark' cafe.id %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit">Save</button>
      </form>
    {% endif %}
  {% endif %}

<h3>Comments</h3>
<ul>
  {% for rating in cafe.ratings.all %}
    {% if rating.comment %}
      <li>
        <strong>{{ rating.user.username }}</strong>: {{ rating.comment }} ({{ rating.created_at|date:"Y-m-d" }})
      </li>
    {% endif %}
  {% empty %}
    <li>No comments yet.</li>
  {% endfor %}
</ul>
{% endblock %}
