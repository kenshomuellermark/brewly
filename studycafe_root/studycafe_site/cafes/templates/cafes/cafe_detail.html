{% extends "base.html" %}
{% block content %}
  <div class="cafe-detail-container">
    <div class="cafe-detail-header">
      <h1 class="cafe-detail-title">{{ cafe.name }}</h1>
      <p class="cafe-detail-address">üìç {{ cafe.address }}</p>
      
      <div class="mt-20">
        <span class="small-text">Posted by <strong>{{ cafe.posted_by.username }}</strong></span>
        {% if user.is_authenticated and user != cafe.posted_by %}
          {% if cafe.posted_by in user.following.values_list.following %}
            <form action="{% url 'unfollow-user' cafe.posted_by.id %}" method="post" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn-outline action-btn" style="padding: 5px 15px; font-size: 14px;">Unfollow</button>
            </form>
          {% else %}
            <form action="{% url 'follow-user' cafe.posted_by.id %}" method="post" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn-accent action-btn" style="padding: 5px 15px; font-size: 14px;">Follow</button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
    
    <div class="cafe-detail-body">
      <div class="mb-30">
        <p style="font-size: 18px; line-height: 1.8; color: #555;">{{ cafe.description }}</p>
      </div>
      
      <div class="cafe-amenities mb-30">
        {% if cafe.has_wifi %}
          <span class="amenity-badge">üì∂ WiFi Available</span>
        {% endif %}
        {% if cafe.has_power_outlet %}
          <span class="amenity-badge">üîå Power Outlets</span>
        {% endif %}
        {% if cafe.has_restroom %}
          <span class="amenity-badge">üöª Restroom</span>
        {% endif %}
      </div>
      
      {% if cafe.opening_time and cafe.closing_time %}
        <div class="mb-30">
          <h3>Opening Hours</h3>
          <p style="font-size: 18px;">
            üïê {{ cafe.opening_time|time:"g:i A" }} - {{ cafe.closing_time|time:"g:i A" }}
            {% if cafe.is_open_now %}
              <span class="cafe-status status-open" style="margin-left: 10px;">Open Now</span>
            {% elif cafe.is_open_now == False %}
              <span class="cafe-status status-closed" style="margin-left: 10px;">Closed</span>
            {% endif %}
          </p>
        </div>
      {% endif %}
      
      <div class="cafe-actions">
        {% if user.is_authenticated %}
          {% if is_bookmarked %}
            <form action="{% url 'remove-bookmark' cafe.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn-bookmark action-btn">üíî Remove from Saved</button>
            </form>
          {% else %}
            <form action="{% url 'add-bookmark' cafe.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn-bookmark action-btn">‚ù§Ô∏è Save Cafe</button>
            </form>
          {% endif %}
        {% endif %}
        
        {% if user == cafe.posted_by %}
          <a href="{% url 'cafe-update' cafe.pk %}" class="action-btn btn-edit">‚úèÔ∏è Edit</a>
          <a href="{% url 'cafe-delete' cafe.pk %}" class="action-btn btn-delete">üóëÔ∏è Delete</a>
        {% endif %}
        
        <a href="{% url 'cafe-list' %}" class="action-btn" style="background-color: #666; color: white;">‚Üê Back to List</a>
      </div>

      <!-- Photo Gallery -->
      <div class="mt-30">
        <h3>Photo Gallery</h3>
        <div class="photo-gallery">
          {% for photo in photos %}
            <div class="photo-item" style="position: relative;">
              <img src="{{ photo.image.url }}" alt="{{ photo.caption }}">
              {% if user == photo.uploaded_by or user == cafe.posted_by %}
                <form action="{% url 'delete-photo' photo.id %}" method="post" style="position: absolute; top: 10px; right: 10px;">
                  {% csrf_token %}
                  <button type="submit" style="background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 20px;">√ó</button>
                </form>
              {% endif %}
            </div>
          {% empty %}
            <p style="grid-column: 1 / -1; text-align: center; color: #999;">No photos yet. Be the first to add one!</p>
          {% endfor %}
        </div>
        
        {% if user.is_authenticated %}
          <div class="form-container mt-30" style="max-width: 400px; margin-left: 0;">
            <h4 class="form-title" style="text-align: left; font-size: 20px;">Add a Photo</h4>
            <form action="{% url 'add-photo' cafe.id %}" method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="form-group">
                {{ photo_form.as_p }}
              </div>
              <button type="submit" class="form-submit" style="width: auto; padding: 12px 30px;">Upload Photo</button>
            </form>
          </div>
        {% endif %}
      </div>

      <!-- Map Integration -->
      {% if cafe.latitude and cafe.longitude %}
        <div class="map-container mt-30">
          <h3 style="padding: 20px 20px 0;">Location</h3>
          <div id="map" class="map-element" style="height: 400px;"></div>
          <div id="resolved-address" style="padding: 15px 20px; background-color: #f8f8f8; color: #555; font-style: italic;"></div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      var lat = {{ cafe.latitude }};
      var lon = {{ cafe.longitude }};
      var map = L.map('map').setView([lat, lon], 16);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
      
      // Add a custom marker with cafe name
      var marker = L.marker([lat, lon]).addTo(map);
      marker.bindPopup('<strong>{{ cafe.name|escapejs }}</strong><br>{{ cafe.address|escapejs }}').openPopup();

      // Show the full address below the map
      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon)
        .then(response => response.json())
        .then(data => {
          if (data && data.display_name) {
            document.getElementById('resolved-address').textContent = data.display_name;
          } else {
            document.getElementById('resolved-address').textContent = '{{ cafe.address }}';
          }
        })
        .catch(error => {
          document.getElementById('resolved-address').textContent = '{{ cafe.address }}';
        });
    </script>
        </div>
      {% else %}
        <div class="alert alert-info mt-30">
          <p><em>Location not available for this cafe.</em></p>
        </div>
      {% endif %}
      
      <!-- Ratings and Comments Section -->
      <div class="comments-section">
        <h2 class="comments-title">Reviews{% if cafe.average_rating > 0 %} <span style="font-size: 20px; color: #f59e0b;">(‚≠ê {{ cafe.average_rating|floatformat:1 }}/5)</span>{% endif %}</h2>
        
        {% if user.is_authenticated %}
          <div class="form-container mb-30" style="max-width: 600px; margin-left: 0;">
            <h4 class="form-title" style="text-align: left; font-size: 20px;">Add Your Review</h4>
            <form action="{% url 'add-rating' cafe.id %}" method="post">
              {% csrf_token %}
              <div class="form-group">
                <label for="stars" class="form-label">Rating</label>
                <select name="stars" class="form-input" required>
                  <option value="">Select a rating...</option>
                  <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
                  <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Very Good</option>
                  <option value="3">‚≠ê‚≠ê‚≠ê Good</option>
                  <option value="2">‚≠ê‚≠ê Fair</option>
                  <option value="1">‚≠ê Poor</option>
                </select>
              </div>
              <div class="form-group">
                <label for="comment" class="form-label">Comment (optional)</label>
                <textarea name="comment" class="form-textarea" placeholder="Share your experience..."></textarea>
              </div>
              <button type="submit" class="form-submit" style="width: auto; padding: 12px 30px;">Submit Review</button>
            </form>
          </div>
        {% else %}
          <div class="alert alert-info">
            <p><a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to rate this cafe.</p>
          </div>
        {% endif %}
        
        <div>
          {% for rating in cafe.ratings.all %}
            <div class="comment-item">
              <div class="comment-header">
                <span class="comment-author">{{ rating.user.username }}</span>
                <span class="comment-date">{{ rating.created_at|date:"M d, Y" }}</span>
              </div>
              <div class="comment-rating">
                {% if rating.stars == 1 %}‚≠ê
                {% elif rating.stars == 2 %}‚≠ê‚≠ê
                {% elif rating.stars == 3 %}‚≠ê‚≠ê‚≠ê
                {% elif rating.stars == 4 %}‚≠ê‚≠ê‚≠ê‚≠ê
                {% elif rating.stars == 5 %}‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
                {% endif %} ({{ rating.stars }}/5)
              </div>
              {% if rating.comment %}
                <p class="comment-text">{{ rating.comment }}</p>
              {% endif %}
              {% if user == rating.user %}
                <form action="{% url 'delete-rating' rating.id %}" method="post" style="margin-top: 10px;">
                  {% csrf_token %}
                  <button type="submit" class="btn-outline action-btn" style="padding: 5px 15px; font-size: 14px;">Delete</button>
                </form>
              {% endif %}
            </div>
          {% empty %}
            <div class="text-center" style="padding: 40px 0; color: #999;">
              <p>No reviews yet. Be the first to review this cafe!</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
